<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digest System Manual Testing</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; text-align: center; }
        h2 { color: #34495e; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        button {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2980b9; }
        .success { background: #d4edda; color: #155724; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .error { background: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; }
        .response {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .token-display {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-pending { background: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Digest System Manual Testing Interface</h1>
        <p style="text-align: center; color: #666;">Complete testing interface for the Personalized Digests and Notifications API</p>

        <!-- Server Status -->
        <div class="test-section">
            <h2>üöÄ Server Status</h2>
            <button onclick="checkServerStatus()">Check Server Status</button>
            <div id="serverStatus"></div>
        </div>

        <!-- Authentication -->
        <div class="test-section">
            <h2>üîê Authentication</h2>
            
            <h3>Register User</h3>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="regEmail" value="testuser@example.com">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="regPassword" value="password123">
            </div>
            <div class="form-group">
                <label>Full Name:</label>
                <input type="text" id="regFullName" value="Test User">
            </div>
            <button onclick="registerUser()">Register</button>
            <div id="registerResponse"></div>

            <h3>Login</h3>
            <div class="form-group">
                <label>Email:</label>
                <input type="email" id="loginEmail" value="testuser@example.com">
            </div>
            <div class="form-group">
                <label>Password:</label>
                <input type="password" id="loginPassword" value="password123">
            </div>
            <button onclick="loginUser()">Login</button>
            <div id="loginResponse"></div>
            <div id="tokenDisplay" class="token-display" style="display: none;"></div>
        </div>

        <!-- Categories -->
        <div class="test-section">
            <h2>üìã Categories</h2>
            <button onclick="getCategories()">Get All Categories</button>
            <div id="categoriesResponse"></div>
        </div>

        <!-- User Profile -->
        <div class="test-section">
            <h2>üë§ User Profile & Preferences</h2>
            <button onclick="getUserProfile()">Get My Profile</button>
            <button onclick="getPreferences()">Get My Preferences</button>
            <div id="profileResponse"></div>

            <h3>Update Preferences</h3>
            <div class="form-group">
                <label><input type="checkbox" id="dailyDigest" checked> Daily Digest</label>
                <label><input type="checkbox" id="weeklyDigest" checked> Weekly Digest</label>
                <label><input type="checkbox" id="instantNotifications"> Instant Notifications</label>
            </div>
            <div class="form-group">
                <label>Digest Time:</label>
                <input type="time" id="digestTime" value="08:00">
            </div>
            <div class="form-group">
                <label>Time Zone:</label>
                <input type="text" id="timeZone" value="EST">
            </div>
            <div class="form-group">
                <label>Interested Categories (comma-separated IDs):</label>
                <input type="text" id="interestedCategories" value="1,3,9" placeholder="e.g., 1,3,9">
            </div>
            <button onclick="updatePreferences()">Update Preferences</button>
            <div id="preferencesResponse"></div>
        </div>

        <!-- Subscriptions -->
        <div class="test-section">
            <h2>üîî Subscriptions</h2>
            <button onclick="getSubscriptions()">Get My Subscriptions</button>
            <div id="subscriptionsResponse"></div>

            <h3>Create Keyword Subscription</h3>
            <div class="form-group">
                <label>Keywords (comma-separated):</label>
                <input type="text" id="keywords" value="OpenAI,ChatGPT,LLM" placeholder="e.g., OpenAI,ChatGPT,LLM">
            </div>
            <button onclick="createKeywordSubscription()">Create Subscription</button>
            <div id="createSubscriptionResponse"></div>
        </div>

        <!-- Articles -->
        <div class="test-section">
            <h2>üì∞ Articles</h2>
            <button onclick="getAllArticles()">Get All Articles</button>
            <button onclick="getPersonalizedArticles()">Get Personalized Articles</button>
            
            <h3>Filter by Category</h3>
            <div class="form-group">
                <label>Category ID:</label>
                <input type="number" id="categoryFilter" placeholder="e.g., 1">
            </div>
            <button onclick="getArticlesByCategory()">Get Articles by Category</button>
            <div id="articlesResponse"></div>
        </div>

        <!-- Digests -->
        <div class="test-section">
            <h2>üìß Digests</h2>
            <button onclick="previewDailyDigest()">Preview Daily Digest</button>
            <button onclick="previewWeeklyDigest()">Preview Weekly Digest</button>
            <button onclick="sendDigestNow()">Send Digest Now</button>
            <button onclick="getDigestHistory()">Get Digest History</button>
            <div id="digestResponse"></div>
        </div>
    </div>

    <script>
        let authToken = '';
        const API_BASE = 'http://localhost:8000';

        function showResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = isError ? 'error response' : 'success response';
            element.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            element.style.display = 'block';
        }

        async function checkServerStatus() {
            try {
                const response = await fetch(`${API_BASE}/`);
                const isOk = response.ok;
                const status = isOk ? 'üü¢ Server is running' : 'üî¥ Server error';
                showResponse('serverStatus', status, !isOk);
            } catch (error) {
                showResponse('serverStatus', `üî¥ Server is not accessible: ${error.message}`, true);
            }
        }

        async function registerUser() {
            const data = {
                email: document.getElementById('regEmail').value,
                password: document.getElementById('regPassword').value,
                full_name: document.getElementById('regFullName').value
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('registerResponse', result, !response.ok);
            } catch (error) {
                showResponse('registerResponse', `Error: ${error.message}`, true);
            }
        }

        async function loginUser() {
            const formData = new FormData();
            formData.append('username', document.getElementById('loginEmail').value);
            formData.append('password', document.getElementById('loginPassword').value);

            try {
                const response = await fetch(`${API_BASE}/auth/token`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                
                if (response.ok && result.access_token) {
                    authToken = result.access_token;
                    document.getElementById('tokenDisplay').textContent = `Token: ${authToken.substring(0, 50)}...`;
                    document.getElementById('tokenDisplay').style.display = 'block';
                }
                
                showResponse('loginResponse', result, !response.ok);
            } catch (error) {
                showResponse('loginResponse', `Error: ${error.message}`, true);
            }
        }

        async function getCategories() {
            try {
                const response = await fetch(`${API_BASE}/categories`);
                const result = await response.json();
                showResponse('categoriesResponse', result, !response.ok);
            } catch (error) {
                showResponse('categoriesResponse', `Error: ${error.message}`, true);
            }
        }

        async function getUserProfile() {
            if (!authToken) {
                showResponse('profileResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('profileResponse', result, !response.ok);
            } catch (error) {
                showResponse('profileResponse', `Error: ${error.message}`, true);
            }
        }

        async function getPreferences() {
            if (!authToken) {
                showResponse('profileResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/preferences`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('profileResponse', result, !response.ok);
            } catch (error) {
                showResponse('profileResponse', `Error: ${error.message}`, true);
            }
        }

        async function updatePreferences() {
            if (!authToken) {
                showResponse('preferencesResponse', 'Please login first', true);
                return;
            }

            const categories = document.getElementById('interestedCategories').value
                .split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));

            const data = {
                daily_digest_enabled: document.getElementById('dailyDigest').checked,
                weekly_digest_enabled: document.getElementById('weeklyDigest').checked,
                instant_notifications: document.getElementById('instantNotifications').checked,
                digest_time: document.getElementById('digestTime').value,
                time_zone: document.getElementById('timeZone').value,
                interested_categories: categories
            };

            try {
                const response = await fetch(`${API_BASE}/preferences`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('preferencesResponse', result, !response.ok);
            } catch (error) {
                showResponse('preferencesResponse', `Error: ${error.message}`, true);
            }
        }

        async function getSubscriptions() {
            if (!authToken) {
                showResponse('subscriptionsResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('subscriptionsResponse', result, !response.ok);
            } catch (error) {
                showResponse('subscriptionsResponse', `Error: ${error.message}`, true);
            }
        }

        async function createKeywordSubscription() {
            if (!authToken) {
                showResponse('createSubscriptionResponse', 'Please login first', true);
                return;
            }

            const keywords = document.getElementById('keywords').value
                .split(',').map(k => k.trim()).filter(k => k);

            const data = {
                subscription_type: 'keyword',
                keywords: keywords
            };

            try {
                const response = await fetch(`${API_BASE}/subscriptions`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('createSubscriptionResponse', result, !response.ok);
            } catch (error) {
                showResponse('createSubscriptionResponse', `Error: ${error.message}`, true);
            }
        }

        async function getAllArticles() {
            try {
                const response = await fetch(`${API_BASE}/articles?limit=10`);
                const result = await response.json();
                showResponse('articlesResponse', result, !response.ok);
            } catch (error) {
                showResponse('articlesResponse', `Error: ${error.message}`, true);
            }
        }

        async function getPersonalizedArticles() {
            if (!authToken) {
                showResponse('articlesResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/articles/personalized?limit=10`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('articlesResponse', result, !response.ok);
            } catch (error) {
                showResponse('articlesResponse', `Error: ${error.message}`, true);
            }
        }

        async function getArticlesByCategory() {
            const categoryId = document.getElementById('categoryFilter').value;
            if (!categoryId) {
                showResponse('articlesResponse', 'Please enter a category ID', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/articles?category_id=${categoryId}&limit=10`);
                const result = await response.json();
                showResponse('articlesResponse', result, !response.ok);
            } catch (error) {
                showResponse('articlesResponse', `Error: ${error.message}`, true);
            }
        }

        async function previewDailyDigest() {
            if (!authToken) {
                showResponse('digestResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/digest/preview?digest_type=daily`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('digestResponse', result, !response.ok);
            } catch (error) {
                showResponse('digestResponse', `Error: ${error.message}`, true);
            }
        }

        async function previewWeeklyDigest() {
            if (!authToken) {
                showResponse('digestResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/digest/preview?digest_type=weekly`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('digestResponse', result, !response.ok);
            } catch (error) {
                showResponse('digestResponse', `Error: ${error.message}`, true);
            }
        }

        async function sendDigestNow() {
            if (!authToken) {
                showResponse('digestResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/digest/send?digest_type=daily`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('digestResponse', result, !response.ok);
            } catch (error) {
                showResponse('digestResponse', `Error: ${error.message}`, true);
            }
        }

        async function getDigestHistory() {
            if (!authToken) {
                showResponse('digestResponse', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/digest/history`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                const result = await response.json();
                showResponse('digestResponse', result, !response.ok);
            } catch (error) {
                showResponse('digestResponse', `Error: ${error.message}`, true);
            }
        }

        // Auto-check server status on load
        window.onload = function() {
            checkServerStatus();
        };
    </script>
</body>
</html>